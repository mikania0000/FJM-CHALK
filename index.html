<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>é³³ç”²åœ‹ä¸­ç²‰ç­†é ˜å–ç™»è¨˜è¡¨</title>
    
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #8D6E63;
        --primary-hover: #6D4C41;
        --bg-color: #F9F7F2;
        --text-color: #4E342E;
        --card-bg: #FFFFFF;
        --accent-yellow: #FFF8E1;
        --border-radius: 16px;
      }
      
      body {
        background-color: var(--bg-color);
        font-family: 'Noto Sans TC', sans-serif;
        color: var(--text-color);
        background-image: radial-gradient(#EFEBE9 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative;
      }

      /* å€’æ•¸è¨ˆæ™‚å™¨ - å­—é«”åŠ å¤§ */
      #idleTimer {
        position: fixed; top: 10px; right: 15px;
        background-color: rgba(141, 110, 99, 0.9);
        color: white; padding: 8px 18px; border-radius: 20px;
        font-size: 1.1rem; z-index: 1000; font-weight: 500; /* åŸ 0.9rem -> 1.1rem */
        transition: opacity 0.3s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      #idleTimer.urgent { background-color: #e53935; animation: pulse 1s infinite; }
      @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

      /* ä¸»å®¹å™¨ */
      .container {
        max-width: 650px; margin-top: 40px; margin-bottom: 60px; /*ç¨å¾®åŠ å¯¬ max-width */
        background: var(--card-bg); padding: 40px; border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.08); border: 1px solid #EFEBE9;
      }
      @media (max-width: 576px) { .container { margin-top: 70px; padding: 25px; margin-bottom: 20px; } }

      /* æ¨™é¡Œèˆ‡æ–‡å­— - å­—é«”åŠ å¤§ */
      .header-title {
        text-align: center; color: var(--primary-color); margin-bottom: 15px;
        font-family: 'Noto Serif TC', serif; font-weight: 900; font-size: 2.5rem; /* åŸ 2.2rem -> 2.5rem */
        letter-spacing: 2px; position: relative; padding-bottom: 15px;
      }
      .header-title::after {
        content: ""; display: block; width: 80px; height: 5px;
        background-color: var(--primary-color); margin: 10px auto 0;
        border-radius: 2px; opacity: 0.5;
      }
      .sub-title { text-align: center; color: #8D6E63; font-size: 1.2rem; margin-bottom: 35px; font-family: 'Noto Serif TC', serif; font-weight: 600; } /* åŸ 1rem -> 1.2rem */
      
      label.form-label, label { font-weight: 600; color: #5D4037; font-size: 1.25rem; } /* åŸ 1.05rem -> 1.25rem */
      
      /* è¡¨å–®å…ƒä»¶ - å­—é«”åŠ å¤§ */
      .form-select {
        border-radius: 10px; border: 1px solid #D7CCC8; padding: 12px 15px;
        background-color: #FAFAFA; color: #5D4037; font-size: 1.2rem; cursor: pointer; /* åŸ 1rem -> 1.2rem */
      }
      .form-select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(141, 110, 99, 0.25); }
      .quantity-select { min-width: 110px !important; } /* ç¨å¾®åŠ å¯¬ */

      /* ç²‰ç­†å€å¡Š - å­—é«”åŠ å¤§ */
      .chalk-section-title {
        font-family: 'Noto Serif TC', serif; font-size: 1.5rem; color: var(--primary-color); /* åŸ 1.3rem -> 1.5rem */
        border-bottom: 2px dashed #D7CCC8; padding-bottom: 12px; margin-bottom: 25px; margin-top: 25px;
      }
      .chalk-row {
        display: flex; align-items: center; margin-bottom: 18px; padding: 14px 18px;
        border-radius: 12px; background-color: #fff; border: 1px solid #F5F5F5;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .chalk-row:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: #EFEBE9; }
      
      .chalk-icon {
        width: 36px; height: 36px; border-radius: 50%; margin-right: 18px; /* icon ä¹Ÿç¨å¾®åŠ å¤§ */
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #fff; flex-shrink: 0;
      }
      .bg-white-chalk { background-color: #ffffff; border: 2px solid #ddd; }
      .bg-red-chalk { background-color: #ff8a80; }
      .bg-green-chalk { background-color: #a5d6a7; }
      .bg-yellow-chalk { background-color: #ffe082; }
      .bg-blue-chalk { background-color: #90caf9; }
      .chalk-name { flex-grow: 1; font-size: 1.25rem; letter-spacing: 0.5px; color: #5D4037; } /* åŸ 1.05rem -> 1.25rem */

      /* æ¿æ“¦å€å¡Š - å­—é«”åŠ å¤§ */
      .eraser-section {
        background-color: var(--accent-yellow); padding: 25px; border-radius: 2px 12px 12px 12px;
        border: none; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); margin-top: 35px;
        position: relative; border-top: 5px solid #FFD54F;
      }
      .notice-text {
        font-size: 1.15em; color: #795548; font-weight: normal; margin-top: 15px; /* åŸ 0.95em -> 1.15em */
        line-height: 1.6; background: rgba(255, 255, 255, 0.5); padding: 12px; border-radius: 8px;
      }
      .highlight {
        color: #D84315; font-weight: bold;
        background: linear-gradient(180deg, rgba(255,255,255,0) 60%, #FFCCBC 60%); padding: 0 4px;
      }

      /* æŒ‰éˆ• - å­—é«”åŠ å¤§ */
      .btn-primary {
        background-color: var(--primary-color); border-color: var(--primary-color); border-radius: 50px;
        padding: 14px 35px; font-size: 1.3rem; letter-spacing: 1.5px; font-weight: 500; /* åŸ 1.1rem -> 1.3rem */
        box-shadow: 0 4px 10px rgba(141, 110, 99, 0.3); transition: all 0.3s;
      }
      .btn-primary:hover {
        background-color: var(--primary-hover); border-color: var(--primary-hover);
        transform: translateY(-2px); box-shadow: 0 6px 15px rgba(141, 110, 99, 0.4);
      }

      /* Loading èˆ‡ é®ç½© */
      .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(249, 247, 242, 0.9); display: none;
        justify-content: center; align-items: center; z-index: 9999; flex-direction: column;
      }
      .loading-text { margin-top: 15px; color: var(--primary-color); font-weight: 500; letter-spacing: 1px; font-size: 1.2rem; }
      
      #timeoutOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #333; color: white; z-index: 10000; display: none;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
      }

      /* å…¬å‘Šå€å¡Šç¾åŒ– - å­—é«”åŠ å¤§ */
      #dynamicNotice {
        text-align: left;        
        line-height: 1.8;        
        padding: 18px 22px;      
        border-radius: 12px;
        box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
        font-size: 1.15rem; /* åŠ å¤§å…¬å‘Šå­—é«” */
      }
    </style>
  </head>
  <body>

    <!-- é–’ç½®å€’æ•¸è¨ˆæ™‚å™¨ -->
    <div id="idleTimer">é–’ç½®å€’æ•¸ 02:00</div>

    <!-- é€¾æ™‚é®ç½© -->
    <div id="timeoutOverlay">
      <h1 style="font-size: 5rem;">â³</h1>
      <h3 style="font-size: 2rem;">æ“ä½œé€¾æ™‚ï¼Œç³»çµ±å·²è‡ªå‹•é—œé–‰</h3>
      <p class="mt-3" style="font-size: 1.2rem;">ç‚ºäº†è³‡è¨Šå®‰å…¨ï¼Œé•·æ™‚é–“æœªæ“ä½œå°‡è‡ªå‹•é—œé–‰é é¢ã€‚</p>
      <button class="btn btn-outline-light mt-4 btn-lg" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
    </div>

    <div class="container">
      <h1 class="header-title">é³³ç”²åœ‹ä¸­ç²‰ç­†é ˜å–</h1>
      <div class="sub-title">è«‹å¡«å¯«ä¸‹è¡¨å®Œæˆç™»è¨˜</div>
      
      <!-- å‹•æ…‹æ³¨æ„äº‹é … -->
      <div id="dynamicNotice" class="alert mt-2 mb-4" style="display:none; white-space: pre-wrap; background-color: #EFEBE9; color: #5D4037; border-left: 5px solid #8D6E63;"></div>
      
      <!-- åˆå§‹ Loading -->
      <div id="initLoader" class="text-center my-5">
        <div class="spinner-border text-secondary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 text-muted" style="font-size: 1.2rem;">é€£ç·šä¸­...</p>
      </div>

      <form id="chalkForm" style="display:none;" onsubmit="handleFormSubmit(this)">
        
        <div class="row g-3 mb-4">
          <div class="col-md-6 col-12">
            <label for="classId" class="form-label">é¸æ“‡ç­ç´š</label>
            <select class="form-select" id="classId" name="classId" required>
              <option value="" disabled selected>è«‹é¸æ“‡...</option>
            </select>
          </div>
          <div class="col-md-6 col-12">
            <label for="seatNo" class="form-label">é¸æ“‡åº§è™Ÿ</label>
            <select class="form-select" id="seatNo" name="seatNo" required>
              <option value="" disabled selected>è¼‰å…¥ä¸­...</option>
            </select>
          </div>
        </div>

        <div class="chalk-section-title">é ˜å–é …ç›®</div>

        <!-- å„è‰²ç²‰ç­† -->
        <div class="chalk-row">
          <div class="chalk-icon bg-white-chalk"></div><span class="chalk-name">ç™½è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="white" id="whiteLimit"><option value="">0</option></select>
        </div>
        <div class="chalk-row">
          <div class="chalk-icon bg-red-chalk"></div><span class="chalk-name">ç´…è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="red" id="redLimit"><option value="">0</option></select>
        </div>
        <div class="chalk-row">
          <div class="chalk-icon bg-green-chalk"></div><span class="chalk-name">ç¶ è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="green" id="greenLimit"><option value="">0</option></select>
        </div>
        <div class="chalk-row">
          <div class="chalk-icon bg-yellow-chalk"></div><span class="chalk-name">é»ƒè‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="yellow" id="yellowLimit"><option value="">0</option></select>
        </div>
        <div class="chalk-row">
          <div class="chalk-icon bg-blue-chalk"></div><span class="chalk-name">è—è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="blue" id="blueLimit"><option value="">0</option></select>
        </div>

        <!-- æ¿æ“¦å€å¡Š -->
        <div class="eraser-section">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <span style="font-size: 1.5rem;">ğŸ«</span>
              <span class="fw-bold ms-2" style="color: #4E342E; font-size: 1.3rem;">æ¿æ“¦é ˜å– (èˆŠæ›æ–°)</span>
            </div>
            <select class="form-select w-auto quantity-select" name="eraser" style="border-color: #FFD54F;">
              <option value="">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div class="notice-text">
            åŸå‰‡ä¸Šä¸€å€‹ç­ç¶­æŒ <span class="highlight">2</span> å€‹æ¿æ“¦ï¼Œè‹¥æ¿æ“¦ç ´æï¼Œ<br>
            å¯æ‹¿ <span class="highlight">èˆŠæ¿æ“¦</span> è‡³ <span class="highlight">è¨­å‚™çµ„</span> æ›´æ›ã€‚
          </div>
        </div>
        
        <div class="d-grid gap-2 mt-5">
          <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªç™»è¨˜</button>
        </div>

      </form>
    </div>

    <!-- é€å‡ºæ™‚çš„é®ç½© -->
    <div class="loading-overlay" id="submitLoader">
      <div class="spinner-border text-secondary" style="width: 4rem; height: 4rem;" role="status"></div>
      <div class="loading-text">æ­£åœ¨å¯«å…¥ç´€éŒ„...</div>
    </div>

    <script>
      // ============================================
      // æ‚¨çš„ Apps Script éƒ¨ç½²ç¶²å€ (Web App URL)
      // ============================================
      const API_URL = "https://script.google.com/macros/s/AKfycbzBIPyUk5CVXL8qSX_fyUkbfQ4aPzY4g6K0Lpqd64X7tik-6RG2ZYvl3TZE3J2_6jGE-w/exec";
      // ============================================

      function showMessage(type, title, text) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({ icon: type, title: title, html: text, confirmButtonColor: '#8D6E63' });
        } else {
          alert(title + "\n" + text);
        }
      }

      // --- é–’ç½®è¨ˆæ™‚å™¨é‚è¼¯ ---
      var idleTime = 120; // 2åˆ†é˜
      var idleInterval;

      function startIdleTimer() {
        var timerDisplay = document.getElementById('idleTimer');
        
        idleInterval = setInterval(function() {
          idleTime--;
          
          var minutes = Math.floor(idleTime / 60);
          var seconds = idleTime % 60;
          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;
          
          if(timerDisplay) {
             timerDisplay.innerText = "é–’ç½®å€’æ•¸ " + minutes + ":" + seconds;
             if (idleTime < 10) {
                timerDisplay.classList.add('urgent');
             } else {
                timerDisplay.classList.remove('urgent');
             }
          }

          if (idleTime <= 0) {
            clearInterval(idleInterval);
            handleTimeout();
          }
        }, 1000);

        // æœ‰å‹•ä½œå°±é‡ç½®æ™‚é–“
        var resetEvents = ['mousemove', 'mousedown', 'keypress', 'touchmove', 'click'];
        resetEvents.forEach(function(evt) {
          document.addEventListener(evt, function() {
            if (idleTime > 0) { 
               idleTime = 120;
               if(timerDisplay) {
                   timerDisplay.classList.remove('urgent');
                   timerDisplay.innerText = "é–’ç½®å€’æ•¸ 02:00";
               }
            }
          });
        });
      }

      function handleTimeout() {
        try { window.open('','_self').close(); } catch(e) {}
        document.getElementById('timeoutOverlay').style.display = 'flex';
        if(document.getElementById('idleTimer')) document.getElementById('idleTimer').style.display = 'none';
        document.querySelector('.container').style.display = 'none';
      }

      // --- é é¢è¼‰å…¥ ---
      window.onload = function() {
        startIdleTimer();
        
        // ä¿®æ­£ï¼šåˆå§‹ä¸å†é¡¯ç¤º 1-50ï¼Œæ”¹ç‚º "è¼‰å…¥ä¸­..."
        var seatSelect = document.getElementById('seatNo');
        seatSelect.innerHTML = '<option value="" disabled selected>è¼‰å…¥ä¸­...</option>';

        // ä½¿ç”¨ fetch å‘¼å« GAS API è®€å–è¨­å®š
        fetch(API_URL + "?action=getSettings")
          .then(res => res.json())
          .then(data => {
            if(data.error) {
              throw new Error(data.error);
            }
            initializeForm(data);
          })
          .catch(err => {
            document.getElementById('initLoader').innerHTML = 
              '<p class="text-danger fw-bold">ç„¡æ³•é€£ç·šåˆ°è³‡æ–™åº«ã€‚</p>' + 
              '<small class="text-muted">éŒ¯èª¤åŸå› ï¼š' + err.message + '<br>è«‹ç¢ºèª Apps Script å·²éƒ¨ç½²ç‚ºæ–°ç‰ˆæœ¬ã€‚</small>';
          });
      };

      function initializeForm(data) {
        // å¡«å…¥ç­ç´š
        var classSelect = document.getElementById('classId');
        data.classes.forEach(function(cls) {
          classSelect.add(new Option(cls, cls));
        });

        // å¡«å…¥åº§è™Ÿ (å®Œå…¨ä¾ç…§ Excel è³‡æ–™)
        var seatSelect = document.getElementById('seatNo');
        seatSelect.innerHTML = '<option value="" disabled selected>è«‹é¸æ“‡...</option>';
        if (data.seats && data.seats.length > 0) {
            data.seats.forEach(function(s) {
                var val = s;
                // è‡ªå‹•è£œ 0
                if (!isNaN(s) && Number(s) < 10 && String(s).length < 2) {
                     val = "0" + Number(s);
                }
                seatSelect.add(new Option(val, val));
            });
        } else {
            // å¦‚æœ Excel æ²’åº§è™Ÿï¼Œé¡¯ç¤ºæç¤º
            seatSelect.innerHTML = '<option value="" disabled selected>ç„¡åº§è™Ÿè³‡æ–™</option>';
        }

        // å¡«å…¥å„é¡è‰²ä¸Šé™
        var colors = [
          {id: 'white', key: 'white'},
          {id: 'red', key: 'red'},
          {id: 'green', key: 'green'},
          {id: 'yellow', key: 'yellow'},
          {id: 'blue', key: 'blue'}
        ];

        colors.forEach(function(c) {
           var limit = data.limits[c.key];
           limit = (limit === "" || limit == null) ? 5 : limit;
           
           var select = document.getElementById(c.id + 'Limit');
           select.innerHTML = '<option value="">0</option>';
           for(var i=1; i<=limit; i++) {
             select.add(new Option(i, i));
           }
        });

        // é¡¯ç¤ºå…¬å‘Š (åŠ å…¥æ¨™é¡Œ)
        if(data.limits.notice && data.limits.notice.trim() !== ""){
           var noticeDiv = document.getElementById('dynamicNotice');
           noticeDiv.innerText = "ğŸ“¢ å…¬å‘Šäº‹é …ï¼š\n" + data.limits.notice; 
           noticeDiv.style.display = 'block';
        }

        document.getElementById('initLoader').style.display = 'none';
        document.getElementById('chalkForm').style.display = 'block';
      }

      function handleFormSubmit(form) {
        event.preventDefault();
        
        // æš«åœå€’æ•¸
        clearInterval(idleInterval);
        document.getElementById('submitLoader').style.display = 'flex';

        // æ”¶é›†è¡¨å–®è³‡æ–™
        var formData = new FormData(form);
        var data = Object.fromEntries(formData.entries());

        // ä½¿ç”¨ POST é€å‡ºè³‡æ–™
        fetch(API_URL, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {
            "Content-Type": "text/plain;charset=utf-8"
          }
        })
        .then(res => res.json())
        .then(response => {
           document.getElementById('submitLoader').style.display = 'none';
           
           if(response.status === 'success') {
             showMessage('success', 'ç™»è¨˜æˆåŠŸ', 'è³‡æ–™å·²å¯«å…¥è©¦ç®—è¡¨');
             form.reset();
             // æˆåŠŸå¾Œé‡å•Ÿè¨ˆæ™‚
             idleTime = 120;
             startIdleTimer();
           } else {
             throw new Error(response.message);
           }
        })
        .catch(err => {
           document.getElementById('submitLoader').style.display = 'none';
           showMessage('error', 'ç™¼ç”ŸéŒ¯èª¤', 'ç„¡æ³•å¯«å…¥è³‡æ–™ã€‚<br>' + err.message);
           // å¤±æ•—ä¹Ÿè¦é‡å•Ÿè¨ˆæ™‚
           startIdleTimer();
        });
      }
    </script>
  </body>
</html>