<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <title>é³³ç”²åœ‹ä¸­ç²‰ç­†é ˜å–ç™»è¨˜è¡¨</title>
    <!-- å¼•å…¥ Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- å¼•å…¥ SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- å¼•å…¥ Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500&family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    
    <style>
      :root {
        --primary-color: #8D6E63;
        --primary-hover: #6D4C41;
        --bg-color: #F9F7F2;
        --text-color: #4E342E;
        --card-bg: #FFFFFF;
        --accent-yellow: #FFF8E1;
        --border-radius: 16px;
      }

      body {
        background-color: var(--bg-color);
        font-family: 'Noto Sans TC', sans-serif;
        color: var(--text-color);
        background-image: radial-gradient(#EFEBE9 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative; /* For timer positioning */
      }

      /* å€’æ•¸è¨ˆæ™‚å™¨æ¨£å¼ */
      #idleTimer {
        position: fixed;
        top: 10px;
        right: 15px;
        background-color: rgba(141, 110, 99, 0.9);
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.9rem;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        font-weight: 500;
        transition: opacity 0.3s;
      }
      #idleTimer.urgent {
        background-color: #e53935; /* ç´…è‰²è­¦ç¤º */
        animation: pulse 1s infinite;
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
      }

      .container {
        max-width: 600px;
        margin-top: 40px;
        margin-bottom: 60px;
        background: var(--card-bg);
        padding: 40px;
        border-radius: var(--border-radius);
        box-shadow: 0 10px 30px rgba(93, 64, 55, 0.08);
        border: 1px solid #EFEBE9;
      }
      
      @media (max-width: 576px) {
        .container {
          margin-top: 50px; /* é¿é–‹ä¸Šæ–¹çš„ Timer */
          padding: 25px;
          margin-bottom: 20px;
        }
      }

      .header-title {
        text-align: center;
        color: var(--primary-color);
        margin-bottom: 10px;
        font-family: 'Noto Serif TC', serif;
        font-weight: 900;
        font-size: 2.2rem;
        letter-spacing: 2px;
        position: relative;
        padding-bottom: 15px;
      }

      .header-title::after {
        content: "";
        display: block;
        width: 60px;
        height: 4px;
        background-color: var(--primary-color);
        margin: 10px auto 0;
        border-radius: 2px;
        opacity: 0.5;
      }

      .sub-title {
        text-align: center;
        color: #8D6E63;
        font-size: 1rem;
        margin-bottom: 30px;
        font-family: 'Noto Serif TC', serif;
        font-weight: 600;
      }

      label.form-label, label {
        font-weight: 600;
        color: #5D4037;
        font-size: 1.05rem;
      }

      .form-select {
        border-radius: 10px;
        border: 1px solid #D7CCC8;
        padding: 10px 15px;
        background-color: #FAFAFA;
        color: #5D4037;
        font-size: 1rem;
        cursor: pointer;
      }
      .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.25rem rgba(141, 110, 99, 0.25);
      }

      .quantity-select {
        min-width: 100px !important; 
      }

      .chalk-section-title {
        font-family: 'Noto Serif TC', serif;
        font-size: 1.3rem;
        color: var(--primary-color);
        border-bottom: 2px dashed #D7CCC8;
        padding-bottom: 10px;
        margin-bottom: 20px;
        margin-top: 20px;
      }

      .chalk-row {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 12px 15px;
        border-radius: 12px;
        background-color: #fff;
        border: 1px solid #F5F5F5;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      
      .chalk-row:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: #EFEBE9;
      }

      .chalk-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        margin-right: 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border: 2px solid #fff;
        flex-shrink: 0;
      }
      
      .bg-white-chalk { background-color: #ffffff; border: 2px solid #ddd; }
      .bg-red-chalk { background-color: #ff8a80; }
      .bg-green-chalk { background-color: #a5d6a7; }
      .bg-yellow-chalk { background-color: #ffe082; }
      .bg-blue-chalk { background-color: #90caf9; }
      
      .chalk-name {
        flex-grow: 1;
        font-size: 1.05rem;
        letter-spacing: 0.5px;
        color: #5D4037;
      }

      .eraser-section {
        background-color: var(--accent-yellow);
        padding: 20px;
        border-radius: 2px 12px 12px 12px;
        border: none;
        box-shadow: 2px 2px 10px rgba(0,0,0,0.05);
        margin-top: 30px;
        position: relative;
        border-top: 4px solid #FFD54F;
      }
      
      .notice-text {
        font-size: 0.95em;
        color: #795548;
        font-weight: normal;
        margin-top: 12px;
        line-height: 1.6;
        background: rgba(255, 255, 255, 0.5);
        padding: 10px;
        border-radius: 8px;
      }
      
      .highlight {
        color: #D84315;
        font-weight: bold;
        background: linear-gradient(180deg, rgba(255,255,255,0) 60%, #FFCCBC 60%);
        padding: 0 4px;
      }

      .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        border-radius: 50px;
        padding: 12px 30px;
        font-size: 1.1rem;
        letter-spacing: 1px;
        font-weight: 500;
        box-shadow: 0 4px 10px rgba(141, 110, 99, 0.3);
        transition: all 0.3s;
      }
      .btn-primary:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 6px 15px rgba(141, 110, 99, 0.4);
      }

      .loading-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(249, 247, 242, 0.9);
        display: none; 
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
      }
      
      .loading-text {
        margin-top: 15px;
        color: var(--primary-color);
        font-weight: 500;
        letter-spacing: 1px;
      }
      
      /* é€¾æ™‚é—œé–‰çš„é®ç½©å±¤ */
      #timeoutOverlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: #333;
        color: white;
        z-index: 10000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
    </style>
  </head>
  <body>

    <!-- é–’ç½®å€’æ•¸è¨ˆæ™‚å™¨ -->
    <div id="idleTimer">é–’ç½®å€’æ•¸ 02:00</div>

    <!-- é€¾æ™‚é®ç½© -->
    <div id="timeoutOverlay">
      <h1>â³</h1>
      <h3>æ“ä½œé€¾æ™‚ï¼Œç³»çµ±å·²è‡ªå‹•é—œé–‰</h3>
      <p class="mt-3">ç‚ºäº†è³‡è¨Šå®‰å…¨ï¼Œé•·æ™‚é–“æœªæ“ä½œå°‡è‡ªå‹•é—œé–‰é é¢ã€‚</p>
      <button class="btn btn-outline-light mt-4" onclick="location.reload()">é‡æ–°æ•´ç†é é¢</button>
    </div>

    <div class="container">
      <h1 class="header-title">é³³ç”²åœ‹ä¸­ç²‰ç­†é ˜å–</h1>
      <div class="sub-title">è«‹å¡«å¯«ä¸‹è¡¨å®Œæˆç™»è¨˜</div>
      
      <!-- å‹•æ…‹æ³¨æ„äº‹é … -->
      <div id="dynamicNotice" class="alert mt-2 mb-4" style="display:none; white-space: pre-line; background-color: #EFEBE9; color: #5D4037; border-left: 4px solid #8D6E63;"></div>
      
      <div id="initLoader" class="text-center my-5">
        <div class="spinner-border text-secondary" role="status"></div>
        <p class="mt-3 text-muted">æ­£åœ¨æº–å‚™è¡¨å–®...</p>
        <p class="text-danger small" id="timeoutMsg" style="display:none;">
          é€£ç·šä¼¼ä¹æœ‰é»ä¹…ï¼Œè«‹ç¢ºèªæ‚¨å·²åœ¨éƒ¨ç½²æ™‚é¸æ“‡ã€Œå»ºç«‹æ–°ç‰ˆæœ¬ã€ã€‚<br>
          æˆ–è€…æª¢æŸ¥è©¦ç®—è¡¨æ˜¯å¦æœ‰ã€Œè¨­å®šã€å·¥ä½œè¡¨ã€‚
        </p>
      </div>

      <form id="chalkForm" style="display:none;" onsubmit="handleFormSubmit(this)">
        
        <div class="row g-3 mb-4">
          <div class="col-md-6 col-12">
            <label for="classId" class="form-label">é¸æ“‡ç­ç´š</label>
            <select class="form-select" id="classId" name="classId" required>
              <option value="" disabled selected>è«‹é¸æ“‡...</option>
            </select>
          </div>
          <div class="col-md-6 col-12">
            <label for="seatNo" class="form-label">é¸æ“‡åº§è™Ÿ</label>
            <select class="form-select" id="seatNo" name="seatNo" required>
            </select>
          </div>
        </div>

        <div class="chalk-section-title">é ˜å–é …ç›®</div>

        <!-- ç™½è‰² -->
        <div class="chalk-row">
          <div class="chalk-icon bg-white-chalk" title="ç™½è‰²"></div>
          <span class="chalk-name">ç™½è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="white" id="whiteLimit"><option value="">0</option></select>
        </div>

        <!-- ç´…è‰² -->
        <div class="chalk-row">
          <div class="chalk-icon bg-red-chalk" title="ç´…è‰²"></div>
          <span class="chalk-name">ç´…è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="red" id="redLimit"><option value="">0</option></select>
        </div>

        <!-- ç¶ è‰² -->
        <div class="chalk-row">
          <div class="chalk-icon bg-green-chalk" title="ç¶ è‰²"></div>
          <span class="chalk-name">ç¶ è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="green" id="greenLimit"><option value="">0</option></select>
        </div>

        <!-- é»ƒè‰² -->
        <div class="chalk-row">
          <div class="chalk-icon bg-yellow-chalk" title="é»ƒè‰²"></div>
          <span class="chalk-name">é»ƒè‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="yellow" id="yellowLimit"><option value="">0</option></select>
        </div>

        <!-- è—è‰² -->
        <div class="chalk-row">
          <div class="chalk-icon bg-blue-chalk" title="è—è‰²"></div>
          <span class="chalk-name">è—è‰²ç²‰ç­†</span>
          <select class="form-select w-auto quantity-select" name="blue" id="blueLimit"><option value="">0</option></select>
        </div>

        <!-- æ¿æ“¦ -->
        <div class="eraser-section">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <span style="font-size: 1.2rem;">ğŸ«</span>
              <span class="fw-bold ms-2" style="color: #4E342E;">æ¿æ“¦é ˜å– (èˆŠæ›æ–°)</span>
            </div>
            <select class="form-select w-auto quantity-select" name="eraser" style="border-color: #FFD54F;">
              <option value="">0</option>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div class="notice-text">
            åŸå‰‡ä¸Šä¸€å€‹ç­ç¶­æŒ <span class="highlight">2</span> å€‹æ¿æ“¦ï¼Œè‹¥æ¿æ“¦ç ´æï¼Œ<br>
            å¯æ‹¿ <span class="highlight">èˆŠæ¿æ“¦</span> è‡³ <span class="highlight">è¨­å‚™çµ„</span> æ›´æ›ã€‚
          </div>
        </div>
        
        <div class="d-grid gap-2 mt-5">
          <button type="submit" class="btn btn-primary btn-lg">ç¢ºèªç™»è¨˜</button>
        </div>

      </form>
    </div>

    <div class="loading-overlay" id="submitLoader">
      <div class="spinner-border text-secondary" style="width: 3rem; height: 3rem;" role="status"></div>
      <div class="loading-text">æ­£åœ¨å¯«å…¥ç´€éŒ„...</div>
    </div>

    <script>
      // === é–’ç½®å€’æ•¸é‚è¼¯ ===
      var idleTime = 120; // 2åˆ†é˜ = 120ç§’
      var idleInterval;

      function startIdleTimer() {
        var timerDisplay = document.getElementById('idleTimer');
        
        idleInterval = setInterval(function() {
          idleTime--;
          
          // æ ¼å¼åŒ–æ™‚é–“ mm:ss
          var minutes = Math.floor(idleTime / 60);
          var seconds = idleTime % 60;
          minutes = minutes < 10 ? "0" + minutes : minutes;
          seconds = seconds < 10 ? "0" + seconds : seconds;
          
          timerDisplay.innerText = "é–’ç½®å€’æ•¸ " + minutes + ":" + seconds;

          // å‰©é¤˜ 10 ç§’è®Šè‰²è­¦ç¤º
          if (idleTime < 10) {
            timerDisplay.classList.add('urgent');
          } else {
            timerDisplay.classList.remove('urgent');
          }

          // æ™‚é–“åˆ°
          if (idleTime <= 0) {
            clearInterval(idleInterval);
            handleTimeout();
          }
        }, 1000);

        // ç›£è½æ“ä½œäº‹ä»¶ï¼Œé‡ç½®è¨ˆæ™‚å™¨
        var resetEvents = ['mousemove', 'mousedown', 'keypress', 'touchmove', 'click'];
        resetEvents.forEach(function(evt) {
          document.addEventListener(evt, function() {
            if (idleTime > 0) { // åªæœ‰é‚„æ²’è¶…æ™‚æ‰é‡ç½®
               idleTime = 120;
               document.getElementById('idleTimer').classList.remove('urgent');
               document.getElementById('idleTimer').innerText = "é–’ç½®å€’æ•¸ 02:00";
            }
          });
        });
      }

      function handleTimeout() {
        // å˜—è©¦é—œé–‰è¦–çª—
        try {
          window.open('','_self').close();
        } catch(e) { console.log('Close blocked'); }
        
        // ç‚ºäº†é˜²æ­¢é—œé–‰å¤±æ•—(ç€è¦½å™¨å®‰å…¨æ€§)ï¼Œé¡¯ç¤ºé®ç½©å±¤
        document.getElementById('timeoutOverlay').style.display = 'flex';
        document.getElementById('idleTimer').style.display = 'none';
        // éš±è—å…§å®¹
        document.querySelector('.container').style.display = 'none';
      }
      // ===================

      window.onload = function() {
        // å•Ÿå‹•å€’æ•¸è¨ˆæ™‚
        startIdleTimer();

        // è¨­å®šé€£ç·šé€¾æ™‚æé†’
        var timeoutTimer = setTimeout(function() {
          var loader = document.getElementById('initLoader');
          if (loader.style.display !== 'none') {
             document.getElementById('timeoutMsg').style.display = 'block';
             Swal.fire({
               icon: 'warning',
               title: 'é€£ç·šé€¾æ™‚',
               html: 'è®€å–è³‡æ–™èŠ±è²»å¤ªä¹…æ™‚é–“ã€‚<br>è«‹ç¢ºèªéƒ¨ç½²ç‰ˆæœ¬æˆ–è©¦ç®—è¡¨è¨­å®šã€‚',
               confirmButtonColor: '#8D6E63'
             });
          }
        }, 8000); 

        // é è¦½æ¨¡å¼
        if (typeof google === 'undefined' || typeof google.script === 'undefined') {
          console.warn('ç›®å‰ç‚ºé è¦½æ¨¡å¼ï¼Œä½¿ç”¨æ¨¡æ“¬æ•¸æ“šã€‚');
          var mockData = {
            classes: ["701 (é è¦½)", "702 (é è¦½)", "801 (é è¦½)", "901 (é è¦½)"],
            limits: {
              white: 10,
              red: 5,
              green: 5,
              yellow: 5,
              blue: 5,
              notice: "åŒå­¸è«‹æ³¨æ„ï¼šæœŸæœ«è«‹å°‡ç²‰ç­†ç›’æ•´ç†ä¹¾æ·¨ã€‚"
            }
          };
          setTimeout(function() {
            clearTimeout(timeoutTimer);
            initializeForm(mockData);
          }, 800);
        } else {
          // æ­£å¼ç’°å¢ƒ
          google.script.run
            .withSuccessHandler(function(data) {
              clearTimeout(timeoutTimer); 
              initializeForm(data);
            })
            .withFailureHandler(function(err) {
              clearTimeout(timeoutTimer); 
              onFailure(err);
            })
            .getSettings();
        }
          
        var seatSelect = document.getElementById('seatNo');
        seatSelect.innerHTML = '<option value="" disabled selected>åº§è™Ÿ</option>';
        for(var i=1; i<=50; i++){
          var val = i < 10 ? '0' + i : i;
          var option = document.createElement("option");
          option.text = val;
          option.value = val;
          seatSelect.add(option);
        }
      };

      function initializeForm(data) {
        if (!data) {
           onFailure(new Error("ç„¡æ³•è®€å–è¨­å®šè³‡æ–™ã€‚"));
           return;
        }

        var classSelect = document.getElementById('classId');
        data.classes.forEach(function(cls) {
          var option = document.createElement("option");
          option.text = cls;
          option.value = cls;
          classSelect.add(option);
        });

        populateLimitSelect('whiteLimit', data.limits.white);
        populateLimitSelect('redLimit', data.limits.red);
        populateLimitSelect('greenLimit', data.limits.green);
        populateLimitSelect('yellowLimit', data.limits.yellow);
        populateLimitSelect('blueLimit', data.limits.blue);

        if(data.limits.notice){
           var noticeDiv = document.getElementById('dynamicNotice');
           noticeDiv.innerText = "ğŸ“¢ " + data.limits.notice;
           noticeDiv.style.display = 'block';
        }

        document.getElementById('initLoader').style.display = 'none';
        document.getElementById('chalkForm').style.display = 'block';
      }

      function populateLimitSelect(elementId, maxLimit) {
        var select = document.getElementById(elementId);
        select.innerHTML = '<option value="">0</option>';
        var limit = (maxLimit === "" || maxLimit === null || maxLimit === undefined) ? 5 : maxLimit;
        for (var i = 1; i <= limit; i++) {
          var option = document.createElement("option");
          option.text = i;
          option.value = i;
          select.add(option);
        }
      }

      function handleFormSubmit(formObject) {
        event.preventDefault();
        
        // æš«åœå€’æ•¸è¨ˆæ™‚ï¼Œé¿å…é€å‡ºéç¨‹ä¸­è¢«é—œé–‰
        clearInterval(idleInterval);
        
        document.getElementById('submitLoader').style.display = 'flex';

        if (typeof google === 'undefined' || typeof google.script === 'undefined') {
          setTimeout(function() {
            document.getElementById('submitLoader').style.display = 'none';
            Swal.fire({
              icon: 'success',
              title: 'é è¦½æ¸¬è©¦æˆåŠŸ',
              text: 'æ­¤ç‚ºé è¦½æ¨¡å¼ã€‚',
              confirmButtonColor: '#8D6E63'
            }).then(() => {
              formObject.reset();
              // é‡å•Ÿè¨ˆæ™‚
              idleTime = 120;
              startIdleTimer();
            });
          }, 1000);
          return;
        }

        google.script.run
          .withSuccessHandler(function() {
            document.getElementById('submitLoader').style.display = 'none';
            Swal.fire({
              icon: 'success',
              title: 'ç™»è¨˜æˆåŠŸ',
              text: 'è³‡æ–™å·²å¯«å…¥è©¦ç®—è¡¨',
              confirmButtonText: 'ç¢ºå®š',
              confirmButtonColor: '#8D6E63'
            }).then(() => {
              formObject.reset();
              // æˆåŠŸå¾Œé‡å•Ÿè¨ˆæ™‚ï¼Œæ–¹ä¾¿ä¸‹ä¸€ä½ä½¿ç”¨
              idleTime = 120;
              startIdleTimer();
            });
          })
          .withFailureHandler(function(err) {
             // å¤±æ•—ä¹Ÿè¦é‡å•Ÿè¨ˆæ™‚
             onFailure(err);
             startIdleTimer();
          })
          .processForm(formObject);
      }

      function onFailure(error) {
        document.getElementById('initLoader').style.display = 'none';
        document.getElementById('submitLoader').style.display = 'none';
        Swal.fire({
          icon: 'error',
          title: 'ç™¼ç”ŸéŒ¯èª¤',
          text: error.message || 'ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ã€‚',
          confirmButtonColor: '#8D6E63'
        });
      }
    </script>
  </body>
</html>